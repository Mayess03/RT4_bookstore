<div class="admin-books-container">
  <!-- Header -->
  <div class="header-section">
    <h1 class="page-title">Books Management</h1>
    <button mat-raised-button color="primary" (click)="openAddBookDialog()">
      <mat-icon>add</mat-icon>
      Add New Book
    </button>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <mat-form-field class="search-field" appearance="outline">
      <mat-label>Search by title, author, or ISBN</mat-label>
      <input matInput [value]="searchTerm()" (input)="searchTerm.set($any($event.target).value)" (keyup.enter)="onSearch()" placeholder="Search books...">
      <mat-icon matPrefix>search</mat-icon>
      <button mat-icon-button matSuffix (click)="onSearch()" *ngIf="searchTerm()">
        <mat-icon>arrow_forward</mat-icon>
      </button>
    </mat-form-field>

    <mat-form-field class="category-filter" appearance="outline">
      <mat-label>Category</mat-label>
      <mat-select [value]="selectedCategoryId()" (selectionChange)="selectedCategoryId.set($event.value); onCategoryChange()">
        <mat-option value="">All Categories</mat-option>
        @for (category of categories(); track category.id) {
          <mat-option [value]="category.id">{{ category.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  <!-- Loading Spinner -->
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  }

  <!-- Books Table -->
  @if (!isLoading()) {
    <div class="table-container">
      <table mat-table [dataSource]="books()" class="books-table">
        
        <!-- Cover Image Column -->
        <ng-container matColumnDef="coverImage">
          <th mat-header-cell *matHeaderCellDef>Cover</th>
          <td mat-cell *matCellDef="let book">
            <img [src]="book.coverImage" [alt]="book.title" class="book-cover" 
                 onerror="this.src='https://via.placeholder.com/50x75?text=No+Image'">
          </td>
        </ng-container>

        <!-- Title Column -->
        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef>Title</th>
          <td mat-cell *matCellDef="let book">{{ book.title }}</td>
        </ng-container>

        <!-- Author Column -->
        <ng-container matColumnDef="author">
          <th mat-header-cell *matHeaderCellDef>Author</th>
          <td mat-cell *matCellDef="let book">{{ book.author }}</td>
        </ng-container>

        <!-- ISBN Column -->
        <ng-container matColumnDef="isbn">
          <th mat-header-cell *matHeaderCellDef>ISBN</th>
          <td mat-cell *matCellDef="let book">{{ book.isbn }}</td>
        </ng-container>

        <!-- Price Column -->
        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>Price</th>
          <td mat-cell *matCellDef="let book">${{ +book.price | number:'1.2-2' }}</td>
        </ng-container>

        <!-- Stock Column -->
        <ng-container matColumnDef="stock">
          <th mat-header-cell *matHeaderCellDef>Stock</th>
          <td mat-cell *matCellDef="let book">
            <mat-chip [class.low-stock]="book.stock < 10" [class.out-of-stock]="book.stock === 0">
              {{ book.stock }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Category Column -->
        <ng-container matColumnDef="category">
          <th mat-header-cell *matHeaderCellDef>Category</th>
          <td mat-cell *matCellDef="let book">{{ getCategoryName(book.categoryId) }}</td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let book">
            <mat-chip [class.active-status]="book.isActive" [class.inactive-status]="!book.isActive">
              {{ book.isActive ? 'Active' : 'Inactive' }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let book">
            <button mat-icon-button [matTooltip]="'Edit book'" (click)="openEditBookDialog(book)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button [matTooltip]="'Update stock'" (click)="updateStock(book)">
              <mat-icon>inventory</mat-icon>
            </button>
            <button mat-icon-button [matTooltip]="book.isActive ? 'Deactivate' : 'Activate'" (click)="toggleBookStatus(book)">
              <mat-icon>{{ book.isActive ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <button mat-icon-button color="warn" [matTooltip]="'Delete book'" (click)="deleteBook(book)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <!-- No data row -->
        @if (books().length === 0) {
          <tr class="mat-row no-data-row">
            <td [attr.colspan]="displayedColumns.length" class="no-data-cell">
              <div class="no-data-message">
                <mat-icon>book</mat-icon>
                <p>No books found</p>
              </div>
            </td>
          </tr>
        }
      </table>
    </div>

    <!-- Pagination -->
    <mat-paginator 
      [length]="totalBooks()"
      [pageSize]="limit()"
      [pageIndex]="page() - 1"
      [pageSizeOptions]="[5, 10, 25, 50]"
      (page)="onPageChange($event)"
      showFirstLastButtons>
    </mat-paginator>
  }
</div>
