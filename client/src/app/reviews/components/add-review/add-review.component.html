<div class="bg-stone-50 border border-stone-200 rounded-lg p-6">
  <h3 class="text-lg font-semibold text-stone-900 mb-4">
    @if (isUpdating()) {
      Update Your Review
    } @else {
      Write a Review
    }
  </h3>

  @if (loadingExisting()) {
    <div class="flex justify-center py-4">
      <p class="text-stone-600">Checking for existing review...</p>
    </div>
  } @else {
    <form [formGroup]="form" class="space-y-4">
      <!-- Rating Selection -->
      <div>
        <label class="block text-sm font-medium text-stone-700 mb-2">Rating</label>
        <div class="flex gap-2">
          @for (index of [1, 2, 3, 4, 5]; track index) {
            <button
              type="button"
              (click)="setRating(index)"
              class="p-1 transition-colors"
              [class.text-yellow-400]="index <= selectedRating()"
              [class.text-stone-300]="index > selectedRating()"
            >
              @if (index <= selectedRating()) {
                <mat-icon class="text-3xl">star</mat-icon>
              } @else {
                <mat-icon class="text-3xl">star_border</mat-icon>
              }
            </button>
          }
        </div>
        @if (form.get('rating')?.invalid && form.get('rating')?.touched) {
          <p class="text-red-600 text-sm mt-1">Rating is required</p>
        }
      </div>

      <!-- Comment -->
      <div>
        <label for="comment" class="block text-sm font-medium text-stone-700 mb-2">
          Comment <span class="text-stone-500">(Optional)</span>
        </label>
        <textarea
          id="comment"
          formControlName="comment"
          placeholder="Share your thoughts about this book..."
          rows="4"
          class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-600 focus:border-transparent resize-none"
        ></textarea>
        @if (form.get('comment')?.invalid && form.get('comment')?.touched) {
          <p class="text-red-600 text-sm mt-1">Comment must be less than 500 characters</p>
        }
        <p class="text-xs text-stone-500 mt-1">{{ form.get('comment')?.value?.length || 0 }}/500</p>
      </div>

      <!-- Buttons -->
      <div class="flex gap-3 justify-end">
        @if (isUpdating()) {
          <button
            type="button"
            (click)="cancel()"
            [disabled]="submitting()"
            class="px-4 py-2 text-red-700 bg-red-100 rounded-lg font-medium hover:bg-red-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            @if (submitting()) {
              <span class="inline-block animate-spin">⏳</span>
            } @else {
              <mat-icon class="text-lg inline">delete</mat-icon>
            }
            Delete Review
          </button>
        }
        <button
          type="button"
          (click)="cancel()"
          [disabled]="submitting()"
          class="px-4 py-2 text-stone-700 bg-stone-200 rounded-lg font-medium hover:bg-stone-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Cancel
        </button>
        <button
          type="button"
          (click)="submitReview()"
          [disabled]="submitting() || form.invalid"
          class="px-6 py-2 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-2"
        >
          @if (submitting()) {
            <span class="inline-block animate-spin">⏳</span>
            @if (isUpdating()) {
              Updating...
            } @else {
              Posting...
            }
          } @else {
            <mat-icon class="text-lg">send</mat-icon>
            @if (isUpdating()) {
              Update Review
            } @else {
              Post Review
            }
          }
        </button>
      </div>
    </form>
  }
</div>
